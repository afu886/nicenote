#!/bin/bash
##############################################################################
# Claude Code å¾ªç¯å®¡æŸ¥ & ä¼˜åŒ–è„šæœ¬
#
# æ¯è½®åªè°ƒç”¨ä¸€æ¬¡ Claude Codeï¼Œä¸€æ¬¡æ€§å®Œæˆï¼šå®¡æŸ¥ â†’ ä¿®å¤ â†’ éªŒè¯ â†’ æ€»ç»“
#
# ç”¨æ³•ï¼š
#   chmod +x tools/code-review/claude-loop.sh
#   ./tools/code-review/claude-loop.sh [é¡¹ç›®æ ¹ç›®å½•] [æœ€å¤§è½®æ•°]
#
# ç¤ºä¾‹ï¼š
#   ./tools/code-review/claude-loop.sh . 5
##############################################################################

set -euo pipefail

PROJECT_DIR="${1:-../../}"
MAX_ROUNDS="${2:-15}"
REPORT_DIR="${PROJECT_DIR}/.arch-review"
COOLDOWN=5
TS=$(date +%Y%m%d_%H%M%S)
RUN_DIR="${REPORT_DIR}/run_${TS}"

RED='\033[0;31m'; GREEN='\033[0;32m'; YELLOW='\033[1;33m'
BLUE='\033[0;34m'; CYAN='\033[0;36m'; NC='\033[0m'

log_info()  { echo -e "${BLUE}[INFO]${NC} $*"; }
log_ok()    { echo -e "${GREEN}[âœ“]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[!]${NC} $*"; }
log_err()   { echo -e "${RED}[âœ—]${NC} $*"; }
log_phase() { echo -e "\n${CYAN}â”â”â” $* â”â”â”${NC}\n"; }

# ======================== å•è½®å®¡æŸ¥ ========================

run_round() {
  local round=$1
  local report="${RUN_DIR}/round_${round}.md"

  # è¯»å–ä¸Šä¸€è½®æ€»ç»“ï¼ˆå¦‚æœ‰ï¼‰
  local prev_context=""
  if [ "$round" -gt 1 ]; then
    local prev="${RUN_DIR}/round_$((round - 1)).md"
    [ -f "$prev" ] && prev_context="
## ä¸Šä¸€è½®å®¡æŸ¥è®°å½•ï¼ˆè¯·å¯¹æ¯”æ”¹è¿›ï¼Œä¸è¦é‡å¤å·²ä¿®å¤çš„é—®é¢˜ï¼‰
$(cat "$prev")"
  fi

  log_phase "ğŸ”„ ç¬¬ ${round}/${MAX_ROUNDS} è½®"

  claude -p "ä½ æ˜¯ä¸€ä½è¿½æ±‚æè‡´ä¼˜é›…çš„èµ„æ·±è½¯ä»¶æ¶æ„å¸ˆã€‚å¯¹é¡¹ç›® $(cd "$PROJECT_DIR" && pwd) æ‰§è¡Œç¬¬ ${round} è½® code review å¹¶ç›´æ¥ä¿®å¤ã€‚

## å®¡æŸ¥ç»´åº¦ï¼ˆå…¨éƒ¨è¦†ç›–ï¼‰

1. **æ¶æ„åˆç†æ€§** â€” æ¨¡å—åˆ’åˆ†ã€èŒè´£å•ä¸€ã€ä¾èµ–æ–¹å‘ã€å±‚æ¬¡æ¸…æ™°
2. **ä»£ç è´¨é‡** â€” å‡½æ•°é•¿åº¦ã€åœˆå¤æ‚åº¦ã€å¯è¯»æ€§ã€DRY åŸåˆ™
3. **ç±»å‹å®‰å…¨** â€” æ¶ˆç­ anyã€å®Œå–„æ³›å‹ã€ä¸¥æ ¼ç±»å‹æ¨æ–­
4. **é”™è¯¯å¤„ç†** â€” async/await å¼‚å¸¸æ•è·ã€é”™è¯¯è¾¹ç•Œã€ç”¨æˆ·å‹å¥½æç¤º
5. **æ€§èƒ½ä¼˜åŒ–** â€” ä¸å¿…è¦çš„é‡æ¸²æŸ“ã€å¤§æ•°æ®å¤„ç†ã€æ‡’åŠ è½½ä¸ä»£ç åˆ†å‰²
6. **å®‰å…¨éšæ‚£** â€” æ•æ„Ÿä¿¡æ¯æ³„éœ²ã€è¾“å…¥æ ¡éªŒã€XSS/æ³¨å…¥é˜²æŠ¤
7. **ä¾èµ–ç®¡ç†** â€” å¾ªç¯ä¾èµ–ã€ç‰ˆæœ¬ä¸€è‡´æ€§ã€æ— ç”¨ä¾èµ–æ¸…ç†
8. **å‘½åè§„èŒƒ** â€” å˜é‡/å‡½æ•°/æ–‡ä»¶å‘½åæ¸…æ™°è¡¨è¾¾æ„å›¾ã€é£æ ¼ç»Ÿä¸€
9. **é‡å¤ä»£ç ** â€” è¯†åˆ«å¹¶æŠ½å–å…¬å…±é€»è¾‘åˆ°å…¬å…±åŒ…
10. **æµ‹è¯•è¦†ç›–** â€” å…³é”®è·¯å¾„æ˜¯å¦æœ‰æµ‹è¯•ã€è¾¹ç•Œæ¡ä»¶è¦†ç›–

## ä¿®å¤åŸåˆ™ï¼ˆæå…¶é‡è¦ï¼Œå¿…é¡»ä¸¥æ ¼éµå®ˆï¼‰

- **ç›´æ¥æ”¶æ•›**ï¼šä¸è¦æ·»åŠ å…¼å®¹å±‚ã€é€‚é…å™¨ã€wrapper æ¥ç»•è¿‡é—®é¢˜ï¼Œè€Œæ˜¯ç›´æ¥ä¿®æ­£æ ¹å› 
- **å‡æ³•ä¼˜å…ˆ**ï¼šåˆ é™¤å†—ä½™ä»£ç ã€æ— ç”¨çš„ä¸­é—´æŠ½è±¡ã€è¿‡åº¦å°è£…ï¼Œä»£ç è¶Šå°‘è¶Šå¥½
- **ä¼˜é›…å®ç°**ï¼šç”¨è¯­è¨€ç‰¹æ€§å’Œæ¡†æ¶èƒ½åŠ›ç›´æ¥è¡¨è¾¾æ„å›¾ï¼Œæ‹’ç» boilerplate
- **æœ€å°æ”¹åŠ¨**ï¼šæ¯æ¬¡åªæ”¹å¿…è¦çš„éƒ¨åˆ†ï¼Œç¡®ä¿ä¸ç ´åç°æœ‰åŠŸèƒ½
- **ä¸€æ­¥åˆ°ä½**ï¼šä¿®å¤è¦å½»åº•ï¼Œä¸ç•™ TODOã€ä¸ç•™ä¸´æ—¶æ–¹æ¡ˆ

## å·¥ä½œæµç¨‹

è¯·ä¸¥æ ¼æŒ‰é¡ºåºæ‰§è¡Œï¼š

**STEP 1 â€” æ‰«æå‘ç°é—®é¢˜**
éå†é¡¹ç›®æ‰€æœ‰å…³é”®æ–‡ä»¶ï¼ŒæŒ‰ 10 ä¸ªç»´åº¦é€ä¸€æ£€æŸ¥ï¼Œè®°å½•é—®é¢˜æ¸…å•ã€‚

**STEP 2 â€” ç›´æ¥ä¿®å¤**
å¯¹å‘ç°çš„é—®é¢˜æŒ‰ä¼˜å…ˆçº§ï¼ˆP0â†’P1â†’P2ï¼‰é€ä¸€ä¿®å¤æ–‡ä»¶ã€‚ä¿®å¤æ—¶ç›´æ¥æ”¹ä»£ç ï¼Œä¸è¦åªç»™å»ºè®®ã€‚

**STEP 3 â€” éªŒè¯**
ä¿®å¤åè¿è¡Œç±»å‹æ£€æŸ¥ï¼ˆtsc/npx tsc --noEmitï¼‰å’Œ lintï¼ˆå¦‚æœ‰ï¼‰ï¼Œç¡®è®¤æ— æ–°é”™è¯¯ã€‚

**STEP 4 â€” è¾“å‡ºæŠ¥å‘Š**
ç”¨ä»¥ä¸‹æ ¼å¼è¾“å‡ºæœ¬è½®ç»“æœï¼š

\`\`\`
=== ç¬¬ ${round} è½®å®¡æŸ¥æŠ¥å‘Š ===

å¥åº·åº¦: X/10ï¼ˆå¯¹æ¯”ä¸Šè½® +/- Nï¼‰

## å·²ä¿®å¤
- [P0/P1/P2] æ–‡ä»¶è·¯å¾„: é—®é¢˜ç®€è¿° â†’ ä¿®å¤æ–¹å¼

## é—ç•™é—®é¢˜
- [ä¼˜å…ˆçº§] é—®é¢˜æè¿°ï¼ˆæœªä¿®å¤åŸå› ï¼‰

## ä¸‹è½®å»ºè®®
é‡ç‚¹å…³æ³¨æ–¹å‘

## çŠ¶æ€: CONTINUE æˆ– COMPLETE
ï¼ˆå½“ P0=0 ä¸” P1â‰¤2 æ—¶å¯åˆ¤å®š COMPLETEï¼‰
\`\`\`
${prev_context}" \
    --output-format text \
    2>/dev/null > "$report" || {
      log_err "ç¬¬ ${round} è½®æ‰§è¡Œå¤±è´¥"
      return 1
    }

  log_ok "æŠ¥å‘Šå·²ä¿å­˜: $report"

  # æ£€æŸ¥æ˜¯å¦å®Œæˆ
  if grep -qi "çŠ¶æ€.*COMPLETE\|COMPLETE" "$report" 2>/dev/null; then
    return 2
  fi
  return 0
}

# ======================== æœ€ç»ˆæŠ¥å‘Š ========================

final_report() {
  local total=$1
  local final="${RUN_DIR}/FINAL_REPORT.md"

  local summaries=""
  for ((i=1; i<=total; i++)); do
    local r="${RUN_DIR}/round_${i}.md"
    [ -f "$r" ] && summaries="${summaries}
---
### ç¬¬ ${i} è½®
$(cat "$r")
"
  done

  claude -p "åŸºäºä»¥ä¸‹ ${total} è½®æ¶æ„å®¡æŸ¥è®°å½•ï¼Œç”Ÿæˆæœ€ç»ˆæŠ¥å‘Šã€‚

${summaries}

## æŠ¥å‘Šç»“æ„

# æ¶æ„å®¡æŸ¥æœ€ç»ˆæŠ¥å‘Š

## 1. æ‰§è¡Œæ‘˜è¦
å®¡æŸ¥è½®æ•°ã€é—®é¢˜æ€»æ•°ã€ä¿®å¤æ€»æ•°ã€å¥åº·åº¦å˜åŒ–è¶‹åŠ¿

## 2. å…³é”®æ”¹è¿› TOP 5
æœ€æœ‰ä»·å€¼çš„ 5 é¡¹ä¿®å¤

## 3. æ¶æ„è¯„ä¼°
æ•´ä½“è®¾è®¡ã€å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§è¯„ä»·

## 4. é—ç•™æŠ€æœ¯å€º
æœªè§£å†³çš„é—®é¢˜åŠå»ºè®®å¤„ç†æ—¶é—´çº¿

## 5. è¡ŒåŠ¨è®¡åˆ’
æŒ‰ä¼˜å…ˆçº§æ’åˆ—çš„åç»­ TODO" \
    --output-format text \
    2>/dev/null > "$final" || true

  log_ok "æœ€ç»ˆæŠ¥å‘Š: $final"
}

# ======================== ä¸»æµç¨‹ ========================

main() {
  log_phase "ğŸš€ æ¶æ„å¸ˆå®¡æŸ¥å¾ªç¯å¯åŠ¨"

  command -v claude &>/dev/null || { log_err "è¯·å…ˆå®‰è£… Claude Code: npm i -g @anthropic-ai/claude-code"; exit 1; }
  [ -d "$PROJECT_DIR" ] || { log_err "ç›®å½•ä¸å­˜åœ¨: $PROJECT_DIR"; exit 1; }

  cd "$PROJECT_DIR"
  mkdir -p "$RUN_DIR"

  log_info "é¡¹ç›®: $(pwd)"
  log_info "è½®æ•°: æœ€å¤š $MAX_ROUNDS è½®"
  log_info "æŠ¥å‘Š: $RUN_DIR"

  local done_rounds=0

  for ((r=1; r<=MAX_ROUNDS; r++)); do
    local t0=$(date +%s)

    run_round "$r"
    local rc=$?

    done_rounds=$r
    local elapsed=$(( $(date +%s) - t0 ))
    log_info "è€—æ—¶ ${elapsed}s"

    [ $rc -eq 2 ] && { log_ok "ğŸ‰ è´¨é‡è¾¾æ ‡ï¼Œå®¡æŸ¥å®Œæˆï¼"; break; }
    [ $rc -ne 0 ] && log_warn "æœ¬è½®å¼‚å¸¸ï¼Œç»§ç»­ä¸‹ä¸€è½®"

    [ "$r" -lt "$MAX_ROUNDS" ] && { log_info "å†·å´ ${COOLDOWN}s..."; sleep "$COOLDOWN"; }
  done

  final_report "$done_rounds"

  log_phase "ğŸ“Š å®Œæˆ"
  log_info "å…± ${done_rounds} è½® | æŠ¥å‘Šç›®å½•: ${RUN_DIR}"
  ls "$RUN_DIR"/*.md 2>/dev/null | while read f; do echo "  ğŸ“„ $f"; done
  log_ok "è¯·æŸ¥çœ‹ ${RUN_DIR}/FINAL_REPORT.md"
}

main "$@"